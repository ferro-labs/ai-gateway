name: Catalog Source Check

on:
  schedule:
    - cron: "0 9 * * 1"   # Every Monday 09:00 UTC
  workflow_dispatch:        # Allow manual runs

permissions:
  contents: read
  issues: write             # Needed to open a GitHub issue on failure

jobs:
  check:
    name: Check catalog source URLs
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: ai-gateway/go.mod
          cache-dependency-path: ai-gateway/go.sum

      - name: Run catalog source URL check
        id: check
        run: go run ./scripts/catalog-check
        working-directory: ai-gateway
        continue-on-error: true

      - name: Open issue on failure
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[catalog] Stale source URLs detected â€” ${new Date().toISOString().slice(0,10)}`;

            // Check if there's already an open issue with this title prefix to avoid duplicates.
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'catalog',
            });

            const existing = issues.find(i => i.title.startsWith('[catalog] Stale source URLs'));
            if (existing) {
              console.log(`Issue already open: ${existing.html_url}`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: [
                '## Catalog source URL check failed',
                '',
                'The weekly catalog source URL check found one or more provider pricing pages',
                'returning 4xx/5xx or failing to connect.',
                '',
                '**Action required:** Review the failed run, update any stale entries in',
                '`models/catalog.json`, and close this issue.',
                '',
                `Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              ].join('\n'),
              labels: ['catalog'],
            });
